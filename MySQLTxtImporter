import sys
import os
import mysql.connector
from mysql.connector import Error
import pwinput

print("\nüìÑ Welcome to the TXT ‚Üí MySQL Import Tool!")
print("Please follow the steps below:")
print("1. Enter the full path of the TXT file you want to import (e.g., C:/data/employees.txt).")
print("   - The table in MySQL will be automatically created using the **file name** (without .txt) as the table name.")
print("2. Enter your MySQL connection details: Cluster, username, password, and database name.")
print("3. Enter the delimiter used in your TXT file (e.g., , or | or \\t).")
print("4. The program will create a table with extra columns:")
print("   - SourceID (Primary Key, Auto Increment)")
print("   - SourceTable (table name)")
print("   - SourceDocument (file name with .txt)")
print("5. After import, it will display the number of rows inserted or any errors encountered.\n")

def import_file_to_mysql(file_path, host, user, password, database, delimiter):
    try:
        conn = mysql.connector.connect(
            host=host,
            user=user,
            password=password,
            database=database
        )
        cursor = conn.cursor()

        # get table/file names
        table_name = os.path.splitext(os.path.basename(file_path))[0]   # without .txt
        file_name = os.path.basename(file_path)  # with .txt

        with open(file_path, "r", encoding="utf-8") as f:
            lines = f.readlines()

        # read column names from first row
        columns = lines[0].strip().split(delimiter)

        # add SourceID, SourceTable, SourceDocument columns
        create_query = f"""
        CREATE TABLE `{table_name}` (
            SourceID INT AUTO_INCREMENT PRIMARY KEY,
            SourceTable VARCHAR(255),
            SourceDocument VARCHAR(255),
            {','.join([f'`{col}` VARCHAR(255)' for col in columns])}
        )
        """
        cursor.execute(create_query)

        row_count = 0
        for line in lines[1:]:
            values = line.strip().split(delimiter)

            insert_query = f"""
            INSERT INTO `{table_name}` (SourceTable, SourceDocument, {','.join(columns)})
            VALUES (%s, %s, {','.join(['%s'] * len(values))})
            """
            cursor.execute(insert_query, [table_name, file_name] + values)
            row_count += 1

        conn.commit()
        print(f"\n‚úÖ Successfully inserted {row_count} rows into table '{table_name}'")
        return row_count

    except Error as e:
        print(f"\n‚ùå MySQL Error: {e}")
        return 0

    except FileNotFoundError:
        print(f"\n‚ùå File not found: {file_path}")
        return 0

    finally:
        try:
            if cursor:
                cursor.close()
            if conn:
                conn.close()
        except:
            pass


# ================== MAIN LOOP ==================

while True:

    file_path = input("Enter file path (e.g., C:/data/employees.txt): ")
    host = input("Enter MySQL host (e.g., localhost): ")
    user = input("Enter MySQL username: ")
    password = pwinput.pwinput("Enter MySQL password: ")
    database = input("Enter database name: ")
    delimiter = input("Enter delimiter (e.g., , or | or \\t): ")

    inserted_rows = import_file_to_mysql(file_path, host, user, password, database, delimiter)

    if inserted_rows == 0:
        print("‚ö†Ô∏è No rows inserted due to error. Please try again.\n")

    again = input("\nDo you want to import another file? (y/n): ").strip().lower()
    if again != "y":
        print("üëã Exiting application...")
        sys.exit()
